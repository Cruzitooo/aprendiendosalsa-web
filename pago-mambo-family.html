<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Portal de Pagos - Mi Mambo Family</title>
    
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="/style.css"> 
</head>
<body>
    <div class="background-image"></div>

    <div class="container">
        
        <div class="header-v3">
            <h2>Mi Mambo Family</h2>
            <h1>Portal de Pagos</h1>
        </div>

        <hr class="header-divider">

        <div id="profile-section" style="display: none;">
            <div id="foto-perfil" class="profile-picture"></div>
            
            <p id="welcome-message"><strong>Bienvenido/a, <span id="nombre-miembro"></span></strong></p>
        </div>
        
        <div id="info-pago" style="display: none; text-align: left; margin: 1.5rem 0;">
            <div style="background-color: #f9f9f9; border-radius: 12px; border: 1px solid #eee; padding: 1rem; margin-top: 1rem;">
                <p style="margin-bottom: 0.5rem;"><strong>Desglose de tu cuota mensual:</strong></p>
                <div id="desglose-pago" style="padding-left: 1rem;"></div>
            </div>
            
            <hr style="margin: 1.5rem 0; border: 0; border-top: 1px solid #eee;">
            
            <p class="total-line" style="font-size: 1.3rem; font-weight: bold; text-align: right;">Total a Pagar: <span id="total-pago" style="color: #3a67f9;">--.-- €</span></p>
        </div>
        
        <button type="button" id="boton-pagar" disabled>Pagar con Tarjeta</button>

        <div id="loader" class="loader"></div>
        <div id="mensaje-cargando" class="mensaje-cargando"></div>
        <div id="payment-error" style="color: red; margin-top: 10px; font-weight: bold;"></div>

        <div class="footer-logo-container">
            <img src="logo-mambo-family.png" alt="Logo Mi Mambo Family" class="footer-logo" />
        </div>
        
        <div class="stripe-logo-container">
            <img src="Powered-by-Stripe.png" alt="Logo Stripe" class="stripe-logo">
        </div>
    </div>

    <script>
        // Referencias a los elementos
        const loader = document.getElementById('loader');
        const mensajeCargando = document.getElementById('mensaje-cargando');
        const errorDiv = document.getElementById('payment-error');
        const infoPagoDiv = document.getElementById('info-pago');
        const botonPagar = document.getElementById('boton-pagar');
        const profileSection = document.getElementById('profile-section');
        const fotoPerfilDiv = document.getElementById('foto-perfil'); // Ahora es una Div
        const nombreMiembroSpan = document.getElementById('nombre-miembro');
        let datosMiembroGlobal = null;
        let miembroIdGlobal = null;

        document.addEventListener('DOMContentLoaded', async () => {
            mensajeCargando.textContent = "Cargando tus datos de pago...";
            loader.style.display = 'block';
            mensajeCargando.style.display = 'block';

            const params = new URLSearchParams(window.location.search);
            miembroIdGlobal = params.get('id');

            if (!miembroIdGlobal) {
                mostrarError("Enlace inválido. No se encontró el identificador del miembro.");
                return;
            }

            const backendUrl = `https://stripe-backend-apprendiendo.onrender.com/api/pagos-mambo-family/datos-miembro/${miembroIdGlobal}`;

            try {
                const response = await fetch(backendUrl);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `Error del servidor: ${response.status}`);
                }
                datosMiembroGlobal = await response.json();
                
                if (datosMiembroGlobal.urlFotoPerfil) {
                    // ===============================================================
                    // == CAMBIO 2: Así se pone la foto como FONDO de la <div>      ==
                    // ===============================================================
                    fotoPerfilDiv.style.backgroundImage = `url('${datosMiembroGlobal.urlFotoPerfil}')`;
                }
                
                nombreMiembroSpan.textContent = datosMiembroGlobal.nombreMiembro || "Miembro";
                profileSection.style.display = 'block';
                
                document.getElementById('total-pago').textContent = `${(datosMiembroGlobal.totalAPagar || 0).toFixed(2)} €`;
                const desgloseHtml = `<p>Cuota Fija: ${(datosMiembroGlobal.cuotaFija || 0).toFixed(2)} €</p><p>Parte de la Sala: ${(datosMiembroGlobal.cuotaSala || 0).toFixed(2)} €</p>${(datosMiembroGlobal.penalizacion || 0) > 0 ? `<p style="color: red;"><strong>Penalización por retraso: ${datosMiembroGlobal.penalizacion.toFixed(2)} €</strong></p>` : ''}`;
                document.getElementById('desglose-pago').innerHTML = desgloseHtml;
                
                loader.style.display = 'none';
                mensajeCargando.style.display = 'none';
                infoPagoDiv.style.display = 'block';
                botonPagar.disabled = false;

            } catch (error) {
                mostrarError(error.message);
            }
        });
        
        // El resto del script para el botón de pagar y mostrar errores se mantiene igual
        botonPagar.addEventListener('click', async () => {
            if (!datosMiembroGlobal || !miembroIdGlobal) {
                mostrarError("No se han cargado los datos para procesar el pago.");
                return;
            }
            mensajeCargando.textContent = "Generando tu enlace de pago seguro...";
            loader.style.display = 'block';
            mensajeCargando.style.display = 'block';
            botonPagar.disabled = true;
            errorDiv.textContent = '';
            const datosParaBackend = {
                concepto: `Cuota Mensual Compañía - ${datosMiembroGlobal.nombreMiembro}`,
                importe: datosMiembroGlobal.totalAPagar,
                email: datosMiembroGlobal.emailMiembro,
                metadata: {
                    tipoPago: 'cuota_mensual_compania',
                    miembroId: miembroIdGlobal,
                    mes: new Date().toLocaleString('es-ES', { month: 'long', year: 'numeric' })
                }
            };
            try {
                const response = await fetch('https://stripe-backend-apprendiendo.onrender.com/crear-enlace', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datosParaBackend)
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `Error ${response.status}`);
                }
                const data = await response.json();
                if (data.url) {
                    window.location.href = data.url;
                } else {
                    throw new Error('El servidor no devolvió una URL de pago.');
                }
            } catch (error) {
                mostrarError(error.message);
            }
        });

        function mostrarError(mensaje) {
            loader.style.display = 'none';
            mensajeCargando.style.display = 'none';
            botonPagar.disabled = false;
            errorDiv.textContent = `Error: ${mensaje}`;
            infoPagoDiv.style.display = 'block';
        }
    </script>
</body>
</html>
