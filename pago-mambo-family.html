<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Portal de Pagos - Mi Mambo Family</title>
    
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="/style.css"> 
</head>
<body>
    <div class="background-image"></div>

    <div class="container">
        
        <div class="header-v3">
            <h2>Mi Mambo Family</h2>
            <h1>Portal de Pagos</h1>
        </div>

        <hr class="header-divider">

        <div id="profile-section" style="display: none;">
            <div id="foto-perfil" class="profile-picture"></div>
            <p id="welcome-message"><strong>Bienvenido/a, <span id="nombre-miembro"></span></strong></p>
        </div>
        
        <div id="payment-selection-container" style="display: none; text-align: left;">
            
            <div id="bloque-mensual"></div>
            
            <div id="bloque-ensayos" style="display: none;">
                <h3 class="block-title">Ensayos Extras Pendientes</h3>
                <div id="lista-ensayos"></div>
            </div>
            
            <div id="bloque-multas" style="display: none;">
                <h3 class="block-title">Multas por Retraso Pendientes</h3>
                <div id="lista-multas"></div>
            </div>

            <hr style="margin: 1.5rem 0; border: 0; border-top: 1px solid #eee;">
            
            <p class="total-line" style="font-size: 1.3rem; font-weight: bold; text-align: right;">
                Total Seleccionado: <span id="total-seleccionado" style="color: #3a67f9;">0.00 €</span>
            </p>
        </div>

        <button type="button" id="boton-pagar" disabled>Pagar con Tarjeta</button>

        <div id="loader" class="loader"></div>
        <div id="mensaje-cargando" class="mensaje-cargando"></div>
        <div id="payment-error" style="color: red; margin-top: 10px; font-weight: bold;"></div>

        <div class="footer-logo-container">
            <img src="logo-mambo-family.png" alt="Logo Mi Mambo Family" class="footer-logo" />
        </div>
        
        <div class="stripe-logo-container">
            <img src="Powered-by-Stripe.png" alt="Logo Stripe" class="stripe-logo">
        </div>
    </div>

    <script>
        // --- Referencias a los elementos de la página ---
        const loader = document.getElementById('loader');
        const mensajeCargando = document.getElementById('mensaje-cargando');
        const errorDiv = document.getElementById('payment-error');
        const botonPagar = document.getElementById('boton-pagar');
        const profileSection = document.getElementById('profile-section');
        const fotoPerfilDiv = document.getElementById('foto-perfil');
        const nombreMiembroSpan = document.getElementById('nombre-miembro');
        const paymentSelectionContainer = document.getElementById('payment-selection-container');
        const totalSeleccionadoSpan = document.getElementById('total-seleccionado');

        // "Mochila" para guardar los datos
        let datosDeudaGlobal = null;
        let miembroIdGlobal = null;

        // --- Lógica Principal al Cargar la Página ---
        document.addEventListener('DOMContentLoaded', async () => {
            mensajeCargando.textContent = "Cargando tu estado de cuentas...";
            loader.style.display = 'block';

            const params = new URLSearchParams(window.location.search);
            miembroIdGlobal = params.get('id');

            if (!miembroIdGlobal) {
                mostrarError("Enlace inválido. No se encontró el identificador del miembro.");
                return;
            }

            const backendUrl = `https://stripe-backend-apprendiendo.onrender.com/api/pagos-mambo-family/datos-miembro/${miembroIdGlobal}`;

            try {
                const response = await fetch(backendUrl);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `Error del servidor: ${response.status}`);
                }
                datosDeudaGlobal = await response.json();
                
                renderizarDeudas(datosDeudaGlobal);

            } catch (error) {
                mostrarError(error.message);
            }
        });
        
        // --- FUNCIÓN 1: El "Constructor" de la Interfaz ---
        function renderizarDeudas(datos) {
            // 1. Rellenar el perfil
            if (datos.miembro.urlFotoPerfil) {
                fotoPerfilDiv.style.backgroundImage = `url('${datos.miembro.urlFotoPerfil}')`;
            }
            nombreMiembroSpan.textContent = datos.miembro.nombre || "Miembro";
            profileSection.style.display = 'block';

            // 2. Rellenar Bloque 1: Deuda Mensual (obligatoria)
            const mensualContainer = document.getElementById('bloque-mensual');
            if (datos.deudaMensual && datos.deudaMensual.importe > 0) {
                
                // --- ▼▼▼ ¡AQUÍ ESTÁ EL CAMBIO! ▼▼▼ ---
                // Le ponemos la "etiqueta" roja a la penalización
                let desgloseHtml = datos.deudaMensual.desglose;
                if (desgloseHtml.includes("Penalización")) {
                    desgloseHtml = desgloseHtml.replace(
                        /(\+ Penalización: [0-9,.]*€)/,
                        `<span class="item-penalizacion">$1</span>`
                    );
                }
                // --- ▲▲▲ FIN DEL CAMBIO ▲▲▲ ---

                mensualContainer.innerHTML = `
                    <h3 class="block-title">Cuota Mensual</h3>
                    <div class="payment-item">
                        <input type="checkbox" id="item-${datos.deudaMensual.id}" data-id="${datos.deudaMensual.id}" data-type="cuota" data-importe="${datos.deudaMensual.importe}" checked disabled>
                        <label for="item-${datos.deudaMensual.id}">
                            <strong>${datos.deudaMensual.concepto}: ${datos.deudaMensual.importe.toFixed(2)} €</strong>
                            <span class="item-desglose">${desgloseHtml}</span>
                        </label>
                    </div>
                `;
            }

            // 3. Rellenar Bloque 2: Ensayos Pendientes (si existen)
            const ensayosContainer = document.getElementById('bloque-ensayos');
            const listaEnsayos = document.getElementById('lista-ensayos');
            if (datos.ensayosPendientes && datos.ensayosPendientes.length > 0) {
                listaEnsayos.innerHTML = datos.ensayosPendientes.map(item => `
                    <div class="payment-item">
                        <input type="checkbox" id="item-${item.id}" data-id="${item.id}" data-type="ensayo" data-importe="${item.importe}">
                        <label for="item-${item.id}">${item.concepto}: ${item.importe.toFixed(2)} €</label>
                    </div>
                `).join('');
                ensayosContainer.style.display = 'block';
            }

            // 4. Rellenar Bloque 3: Multas Pendientes (si existen)
            const multasContainer = document.getElementById('bloque-multas');
            const listaMultas = document.getElementById('lista-multas');
            if (datos.multasPendientes && datos.multasPendientes.length > 0) {
                listaMultas.innerHTML = datos.multasPendientes.map(item => `
                    <div class="payment-item item-penalizacion">
                        <input type="checkbox" id="item-${item.id}" data-id="${item.id}" data-type="multa" data-importe="${item.importe}">
                        <label for="item-${item.id}">${item.concepto}: ${item.importe.toFixed(2)} €</label>
                    </div>
                `).join('');
                multasContainer.style.display = 'block';
            }
            
            // 5. Mostrar todo y activar la calculadora
            loader.style.display = 'none';
            paymentSelectionContainer.style.display = 'block';
            
            // Asignamos el evento para que la calculadora se active con cada clic
            paymentSelectionContainer.addEventListener('change', recalcularTotal);
            recalcularTotal(); // Calculamos el total inicial
        }

        // --- FUNCIÓN 2: La "Calculadora" en Tiempo Real ---
        function recalcularTotal() {
            const itemsSeleccionados = document.querySelectorAll('input[type="checkbox"]:checked');
            let total = 0;
            itemsSeleccionados.forEach(item => {
                total += parseFloat(item.dataset.importe);
            });
            
            totalSeleccionadoSpan.textContent = `${total.toFixed(2)} €`;
            botonPagar.textContent = total > 0 ? `Pagar ${total.toFixed(2)} € con Tarjeta` : 'Nada seleccionado';
            botonPagar.disabled = total === 0;
        }

        // --- Lógica del Botón de Pagar (sin cambios) ---
        botonPagar.addEventListener('click', async () => {
            mensajeCargando.textContent = "Generando tu enlace de pago seguro...";
            loader.style.display = 'block';
            botonPagar.disabled = true;

            const itemsSeleccionados = document.querySelectorAll('input[type="checkbox"]:checked');
            let totalAPagar = 0;
            const cuotaMesPagado = [];
            const ensayosPagadosIds = [];
            const multasPagadasIds = [];

            itemsSeleccionados.forEach(item => {
                totalAPagar += parseFloat(item.dataset.importe);
                const id = item.dataset.id;
                const type = item.dataset.type;
                if (type === 'cuota') cuotaMesPagado.push(id);
                if (type === 'ensayo') ensayosPagadosIds.push(id);
                if (type === 'multa') multasPagadasIds.push(id);
            });

            const datosParaBackend = {
                concepto: `Pago Mixto Compañía - ${datosDeudaGlobal.miembro.nombre}`,
                importe: totalAPagar,
                email: datosDeudaGlobal.miembro.email,
                metadata: {
                    tipoPago: 'pago_mixto_compania',
                    miembroId: miembroIdGlobal,
                    cuotaMesPagado: cuotaMesPagado.join(','),
                    ensayosPagadosIds: ensayosPagadosIds.join(','),
                    multasPagadasIds: multasPagadasIds.join(',')
                }
            };
            
            try {
                const response = await fetch('https://stripe-backend-apprendiendo.onrender.com/crear-enlace', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datosParaBackend)
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `Error ${response.status}`);
                }
                const data = await response.json();
                if (data.url) {
                    window.location.href = data.url;
                } else {
                    throw new Error('El servidor no devolvió una URL de pago.');
                }
            } catch (error) {
                mostrarError(error.message);
            }
        });

        function mostrarError(mensaje) {
            loader.style.display = 'none';
            botonPagar.disabled = false;
            errorDiv.textContent = `Error: ${mensaje}`;
        }
    </script>
</body>
</html>

