<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Portal de Pagos - Mi Mambo Family</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="/style.css"> 
</head>
<body>
    <div class="background-image"></div>

    <div class="container">
        <img src="logo-mambo-family.png" alt="Logo Mi Mambo Family" class="logo" />
        <h1>Portal de Pagos</h1>
        <h2>Mi Mambo Family</h2>

        <div id="info-pago" style="display: none; text-align: left; margin: 1.5rem 0;">
            <p style="font-size: 1.1rem;"><strong>Bienvenido/a, <span id="nombre-miembro"></span></strong></p>
            
            <div style="background-color: #f9f9f9; border-radius: 12px; border: 1px solid #eee; padding: 1rem; margin-top: 1rem;">
                <p style="margin-bottom: 0.5rem;"><strong>Desglose de tu cuota mensual:</strong></p>
                <div id="desglose-pago" style="padding-left: 1rem;">
                </div>
            </div>
            
            <hr style="margin: 1.5rem 0; border: 0; border-top: 1px solid #eee;">
            
            <p style="font-size: 1.3rem; font-weight: bold; text-align: right;">Total a Pagar: <span id="total-pago" style="color: #3a67f9;">--.-- €</span></p>
        </div>
        
        <button type="button" id="boton-pagar" disabled>Pagar con Tarjeta</button>

        <div id="loader" class="loader"></div>
        <div id="mensaje-cargando" class="mensaje-cargando"></div>
        <div id="payment-error" style="color: red; margin-top: 10px; font-weight: bold;"></div>

        <div class="stripe-logo-container">
            <img src="Powered-by-Stripe.png" alt="Logo Stripe" class="stripe-logo">
        </div>
    </div>

    <script>
        // Referencias a los elementos de la página
        const loader = document.getElementById('loader');
        const mensajeCargando = document.getElementById('mensaje-cargando');
        const errorDiv = document.getElementById('payment-error');
        const infoPagoDiv = document.getElementById('info-pago');
        const botonPagar = document.getElementById('boton-pagar');

        // Esta función se ejecuta cuando la página carga
        document.addEventListener('DOMContentLoaded', async () => {
            mensajeCargando.textContent = "Cargando tus datos de pago...";
            loader.style.display = 'block';
            mensajeCargando.style.display = 'block';

            const params = new URLSearchParams(window.location.search);
            const miembroId = params.get('id');

            if (!miembroId) {
                mostrarError("Enlace inválido. No se encontró el identificador del miembro.");
                return;
            }

            const backendUrl = `https://stripe-backend-apprendiendo.onrender.com/api/pagos-mambo-family/datos-miembro/${miembroId}`;

            try {
                const response = await fetch(backendUrl);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `Error del servidor: ${response.status}`);
                }
                const datos = await response.json();
                
                document.getElementById('nombre-miembro').textContent = datos.nombreMiembro || "Miembro";
                document.getElementById('total-pago').textContent = `${(datos.totalAPagar || 0).toFixed(2)} €`;
                
                const desgloseHtml = `
                    <p>Cuota Fija: ${(datos.cuotaFija || 0).toFixed(2)} €</p>
                    <p>Parte de la Sala: ${(datos.cuotaSala || 0).toFixed(2)} €</p>
                    ${(datos.penalizacion || 0) > 0 ? `<p style="color: red;"><strong>Penalización por retraso: ${datos.penalizacion.toFixed(2)} €</strong></p>` : ''}
                `;
                document.getElementById('desglose-pago').innerHTML = desgloseHtml;
                
                loader.style.display = 'none';
                mensajeCargando.style.display = 'none';
                infoPagoDiv.style.display = 'block';
                botonPagar.disabled = false;

            } catch (error) {
                mostrarError(error.message);
            }
        });

        function mostrarError(mensaje) {
            loader.style.display = 'none';
            mensajeCargando.style.display = 'none';
            errorDiv.textContent = `Error: ${mensaje}`;
            infoPagoDiv.style.display = 'none';
        }
    </script>
</body>
</html>
